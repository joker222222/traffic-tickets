<script setup lang="ts">
import { ref, onMounted } from 'vue'

import { useAuthStore } from '../stores/authStore'
import Cookies from 'js-cookie'

const authStore = useAuthStore()

const getNews = async () => {
  if (!authStore.isAuthenticated) {
    try {
      const response = await fetch(`http://localhost:5000/get_all_news_unauth`, {
        method: 'GET',
      })
      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä')
      }
      const data = await response.json()
      newsArray.value = data.message
    } catch {}
  } else {
    const token = Cookies.get('authToken')
    if (!token) {
      return
    }
    const response = await fetch(`http://localhost:5000/get_all_news_authorized`, {
      method: 'GET',
      headers: {
        Authorization: token,
        'Content-Type': 'application/json',
      },
    })
    if (!response.ok) {
      throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä')
    }
    const data = await response.json()
    newsArray.value = data.message
  }
}

interface NewsItem {
  img: string
  text: string
  likes: number
  dislikes: number
  userReaction: 'like' | 'dislike' | null
  showLoginMessage?: boolean
  postId: number
}

const newsArray = ref<NewsItem[]>([
  // {
  //   img: '',
  //   text: `–ì–ª–∞–≤–∞ –ê–≤—Ç–æ–í–ê–ó–∞ –ú–∞–∫—Å–∏–º –°–æ–∫–æ–ª–æ–≤ –Ω–∞–∑–≤–∞–ª —É—Å–ª–æ–≤–∏–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è Renault –≤ –†–æ—Å—Å–∏—é‚ö°Ô∏è
  //   –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –ê–≤—Ç–æ–í–ê–ó—É 112,5 –º–ª—Ä–¥ —Ä—É–±. (‚Ç¨1.2 –º–ª—Ä–¥.), –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ –≥–æ–¥—ã –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ñ—Ä–∞–Ω—Ü—É–∑–æ–≤. –°–∞–º –∂–µ Renault –æ—Ü–µ–Ω–∏–≤–∞–ª —Å–≤–æ–∏ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –∞–∫—Ç–∏–≤—ã –≤—Å–µ–≥–æ –≤ ‚Ç¨2,195 –º–ª—Ä–¥. (–≤–∫–ª—é—á–∞—è –±—ã–≤—à–∏–π –ê–ó–õ–ö).
  //   –°–æ–±—è–Ω–∏–Ω –æ –≤–æ–∑–º–æ–∂–Ω–æ–º –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ Renault –≤—ã—Å–∫–∞–∑–∞–ª—Å—è —Ç–∞–∫:
  //   –ù—É, –æ–Ω, –º–æ–∂–µ—Ç, –∏ –Ω–µ –∏—Å–∫–ª—é—á–∞–µ—Ç, –Ω–æ –≤—Ä—è–¥ –ª–∏ –µ–º—É —á—Ç–æ-—Ç–æ —Ç—É—Ç —Å–≤–µ—Ç–∏—Ç.
  //   –ù–µ –∂–¥—É—Ç —É –Ω–∞—Å –æ–±—Ä–∞—Ç–Ω–æ –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–µ–≤ –ø–æ —Ö–æ–¥—É. –¢–∞–∫ –º—ã –æ—Å—Ç–∞–Ω–µ–º—Å—è –±–µ–∑ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è Mcdonald‚Äôs —Å–æ –í–∫—É—Å–Ω–æ –∏ —Ç–æ—á–∫–æ–π.`,
  //   likes: 2,
  //   dislikes: 0,
  //   userReaction: null,
  //   showLoginMessage: false,
  // },
  // {
  //   img: 'https://images.wallpaperscraft.com/image/single/lake_mountain_tree_36589_2650x1600.jpg',
  //   text: '–Ω–æ–≤–æ—Å—Ç—å2',
  //   likes: 3,
  //   dislikes: 0,
  //   userReaction: null,
  //   showLoginMessage: false,
  // },
  // {
  //   img: 'https://i.pinimg.com/originals/36/76/99/36769945f37cb48d1cc24ba4dc724d94.jpg',
  //   text: '–Ω–æ–≤–æ—Å—Ç—å3',
  //   likes: 3,
  //   dislikes: 0,
  //   userReaction: null,
  //   showLoginMessage: false,
  // },
])

const showLoginMessage = (index: number) => {
  newsArray.value[index].showLoginMessage = true
  setTimeout(() => {
    newsArray.value[index].showLoginMessage = false
  }, 3000)
}

const setStatusLike = async (token: string, postId: number, status: string) => {
  await fetch('http://localhost:5000/set_status_post', {
    method: 'POST',
    body: JSON.stringify({
      id: postId,
      reaction: status,
    }),
    headers: {
      Authorization: token,
      'Content-Type': 'application/json',
    },
  })
}

const toggleLike = async (index: number) => {
  if (!authStore.isAuthenticated) {
    showLoginMessage(index)
    return
  }
  const news = newsArray.value[index]
  const token = Cookies.get('authToken')
  if (news.userReaction === 'like') {
    // –ï—Å–ª–∏ —É–∂–µ —Å—Ç–æ–∏—Ç –ª–∞–π–∫, —É–±–∏—Ä–∞–µ–º –µ–≥–æ
    setStatusLike(token, news.postId, null)
    news.likes--
    news.userReaction = null
  } else {
    // –ï—Å–ª–∏ –±—ã–ª –¥–∏–∑–ª–∞–π–∫, —É–±–∏—Ä–∞–µ–º –µ–≥–æ
    setStatusLike(token, news.postId, 'like')
    if (news.userReaction === 'dislike') {
      news.dislikes--
    }
    news.likes++
    news.userReaction = 'like'
  }
}

const toggleDislike = (index: number) => {
  if (!authStore.isAuthenticated) {
    console.log('–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –¥–∏–∑–ª–∞–π–∫.')
    showLoginMessage(index)
    return
  }
  const news = newsArray.value[index]
  const token = Cookies.get('authToken')
  if (news.userReaction === 'dislike') {
    // –ï—Å–ª–∏ —É–∂–µ —Å—Ç–æ–∏—Ç –¥–∏–∑–ª–∞–π–∫, —É–±–∏—Ä–∞–µ–º –µ–≥–æ
    setStatusLike(token, news.postId, null)
    news.dislikes--
    news.userReaction = null
  } else {
    // –ï—Å–ª–∏ –±—ã–ª –ª–∞–π–∫, —É–±–∏—Ä–∞–µ–º –µ–≥–æ
    setStatusLike(token, news.postId, 'dislike')
    if (news.userReaction === 'like') {
      news.likes--
    }
    news.dislikes++
    news.userReaction = 'dislike'
  }
}
onMounted(getNews)
</script>

<template>
  <div class="news-container">
    <ul>
      <h1 v-if="newsArray.length == 0">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
      <li v-for="(news, index) in newsArray" :key="index" class="news-item">
        <img v-if="news.img" :src="news.img" class="news-img" />
        <h2 class="text-news">{{ news.text }}</h2>
        <div class="number-of-likes">
          <label class="likes" v-on:click="toggleLike(index)"
            >{{ news.userReaction === 'like' ? '‚ù§Ô∏è' : 'ü§ç' }}{{ news.likes }}</label
          >
          <label class="dislikes" v-on:click="toggleDislike(index)"
            >{{ news.userReaction === 'dislike' ? 'üëéüèø' : 'üëéüèª' }}{{ news.dislikes }}</label
          >
          <label class="dislikes" v-if="news.showLoginMessage"
            >–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.</label
          >
        </div>
      </li>
    </ul>
  </div>
</template>

<style scoped>
.news-container {
  display: flex;
  justify-content: center;
  align-items: center;
  max-width: auto;
  margin-top: 50px;
}

ul {
  display: flex;
  flex-direction: column;
  gap: 40px;
  padding: 0;
  list-style: none;
}

.news-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  background-color: #f9f9f9;
  padding: 35px;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  max-width: 1000px;
  width: auto;
  position: relative;
}

.news-img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin-bottom: 15px;
}

.text-news {
  font-size: 18px;
  font-weight: bold;
  text-align: justify;
  color: #333;
  margin: 0;
  word-wrap: break-word;
  overflow-wrap: break-word;
  width: 100%;
}

.number-of-likes {
  position: absolute;
  bottom: 10px;
  left: 35px;
  display: flex;
  gap: 10px;
}

.likes,
.dislikes {
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
  user-select: none;
}
</style>
